name: RERP CI

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

env:
  RUST_BACKTRACE: "1"
  RUST_LOG: "info"
  PYTHON_VERSION: '3.12'

jobs:
  tooling:
    name: Build, Test and Coverage (Tooling)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling[dev]

      - name: Run tooling tests with coverage
        run: cd tooling && .venv/bin/pytest tests/ -v --cov=rerp_tooling --cov-report=term-missing --cov-fail-under=65

  validate-openapi:
    name: Validate OpenAPI Specs
    needs: [tooling]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling

      - name: Validate OpenAPI specs
        run: |
          echo "ğŸ” Validating OpenAPI specifications..."
          tooling/.venv/bin/rerp openapi validate

      - name: Generate BFF specs (dry run)
        run: |
          echo "ğŸ”„ Testing BFF spec generation..."
          tooling/.venv/bin/rerp bff generate-system
          echo "âœ… BFF spec generation successful"

  validate-ports:
    name: Validate Port Assignments
    needs: [validate-openapi]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling

      - name: Validate port assignments
        run: |
          echo "ğŸ” Validating port registry, helm, kind-config, Tiltfile..."
          tooling/.venv/bin/rerp ports validate

  build-and-test:
    name: Build and Test
    needs: [validate-ports]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling

      - name: Patch Cargo.toml to use BRRTRouter and lifeguard from git (CI)
        working-directory: ${{ github.workspace }}
        run: tooling/.venv/bin/rerp ci patch-brrtrouter

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            components/target
          key: ${{ runner.os }}-cargo-rerp-${{ hashFiles('components/**/Cargo.toml', 'components/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-rerp-
      
      - name: Install musl target and tools
        run: |
          rustup target add x86_64-unknown-linux-musl
          sudo apt-get update
          sudo apt-get install -y musl-tools
      
      - name: Build workspace (amd64)
        run: |
          echo "ğŸ”¨ Building RERP workspace for amd64..."
          tooling/.venv/bin/rerp build workspace amd64
      
      - name: Build example service (amd64)
        run: |
          echo "ğŸ”¨ Building example service (auth/idam) for amd64..."
          tooling/.venv/bin/rerp build auth_idam amd64
      
      - name: Build accounting microservices (amd64) - smoke test
        run: |
          echo "ğŸ”¨ Building accounting microservices (workspace) for amd64..."
          tooling/.venv/bin/rerp build microservices amd64 --release
      
      - name: Format check
        run: |
          cd components
          cargo fmt --check || (echo "âŒ Code formatting check failed. Run 'cargo fmt' to fix." && exit 1)
      
      - name: Lint with Clippy
        run: |
          cd components
          cargo clippy --workspace -- -D warnings
      
      - name: Run tests
        run: |
          cd components
          cargo test --workspace --lib
      
      - name: Check documentation
        run: |
          cd components
          cargo doc --workspace --no-deps || true

  build-multiarch:
    name: Build Multi-Architecture
    needs: [build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    env:
      RERP_USE_CROSS: '1'   # Use cross-rs Docker images (include aarch64-linux-musl-gcc, etc.) so aws-lc-sys builds
    strategy:
      matrix:
        architecture: [amd64, arm64, arm7]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling

      - name: Patch Cargo.toml to use BRRTRouter and lifeguard from git (CI)
        working-directory: ${{ github.workspace }}
        run: tooling/.venv/bin/rerp ci patch-brrtrouter

      - name: Cache cargo registry and git
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('components/**/Cargo.toml', 'components/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Cache cargo target (per-architecture)
        uses: actions/cache@v4
        with:
          path: components/target
          key: ${{ runner.os }}-cargo-rerp-target-${{ matrix.architecture }}-${{ hashFiles('components/**/Cargo.toml', 'components/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-rerp-target-${{ matrix.architecture }}-
      
      - name: Install cross
        run: cargo install cross
      
      - name: Build workspace for ${{ matrix.architecture }}
        run: |
          echo "ğŸ”¨ Building RERP workspace for ${{ matrix.architecture }}..."
          tooling/.venv/bin/rerp build workspace ${{ matrix.architecture }}
      
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: rerp-binaries-${{ matrix.architecture }}
          path: components/target/*/release/rerp_*
          retention-days: 7
          if-no-files-found: warn

  build-push-containers:
    name: Build and Push Containers
    needs: [build-multiarch]
    # Future: restrict to merge-on-main only (merge = push to main).
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v')) && needs.build-multiarch.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: read
      packages: write
      id-token: write  # For attest-build-provenance

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling

      - name: Patch Cargo.toml (BRRTRouter, lifeguard from git)
        run: tooling/.venv/bin/rerp ci patch-brrtrouter

      - name: Install musl target and tools
        run: |
          rustup target add x86_64-unknown-linux-musl
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install cross (for arm64/arm7)
        run: cargo install cross

      - name: Build microservices amd64 and copy to build_artifacts/amd64
        run: |
          echo "ğŸ”¨ Building microservices (amd64, release)..."
          tooling/.venv/bin/rerp build microservices amd64 --release
          tooling/.venv/bin/rerp docker copy-artifacts amd64

      - name: Build microservices arm64 and copy to build_artifacts/arm64
        env: { RERP_USE_CROSS: "1" }
        run: |
          echo "ğŸ”¨ Building microservices (arm64, release)..."
          tooling/.venv/bin/rerp build microservices arm64 --release
          tooling/.venv/bin/rerp docker copy-artifacts arm64

      - name: Build microservices arm7 and copy to build_artifacts/arm
        env: { RERP_USE_CROSS: "1" }
        run: |
          echo "ğŸ”¨ Building microservices (arm7, release)..."
          tooling/.venv/bin/rerp build microservices arm7 --release
          tooling/.venv/bin/rerp docker copy-artifacts arm7

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        if: ${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
            echo "extra_tag=" >> "$GITHUB_OUTPUT"
          else
            echo "tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
            if [[ "${{ github.ref }}" == refs/heads/main ]]; then
              echo "extra_tag=latest" >> "$GITHUB_OUTPUT"
            else
              echo "extra_tag=" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Extract metadata for general-ledger
        id: meta-general-ledger
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-general-ledger
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push general-ledger
        id: build-general-ledger
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.general-ledger
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-general-ledger:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-general-ledger:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-general-ledger:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-general-ledger:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-general-ledger.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest general-ledger
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-general-ledger
          subject-digest: ${{ steps.build-general-ledger.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for invoice
        id: meta-invoice
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-invoice
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push invoice
        id: build-invoice
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.invoice
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-invoice:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-invoice:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-invoice:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-invoice:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-invoice.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest invoice
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-invoice
          subject-digest: ${{ steps.build-invoice.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for accounts-receivable
        id: meta-accounts-receivable
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-accounts-receivable
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push accounts-receivable
        id: build-accounts-receivable
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.accounts-receivable
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-accounts-receivable:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-accounts-receivable:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-accounts-receivable:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-accounts-receivable:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-accounts-receivable.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest accounts-receivable
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-accounts-receivable
          subject-digest: ${{ steps.build-accounts-receivable.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for accounts-payable
        id: meta-accounts-payable
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-accounts-payable
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push accounts-payable
        id: build-accounts-payable
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.accounts-payable
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-accounts-payable:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-accounts-payable:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-accounts-payable:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-accounts-payable:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-accounts-payable.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest accounts-payable
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-accounts-payable
          subject-digest: ${{ steps.build-accounts-payable.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for bank-sync
        id: meta-bank-sync
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-bank-sync
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push bank-sync
        id: build-bank-sync
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.bank-sync
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-bank-sync:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-bank-sync:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-bank-sync:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-bank-sync:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-bank-sync.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest bank-sync
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-bank-sync
          subject-digest: ${{ steps.build-bank-sync.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for asset
        id: meta-asset
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-asset
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push asset
        id: build-asset
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.asset
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-asset:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-asset:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-asset:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-asset:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-asset.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest asset
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-asset
          subject-digest: ${{ steps.build-asset.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for budget
        id: meta-budget
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-budget
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push budget
        id: build-budget
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.budget
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-budget:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-budget:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-budget:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-budget:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-budget.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest budget
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-budget
          subject-digest: ${{ steps.build-budget.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for edi
        id: meta-edi
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-edi
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push edi
        id: build-edi
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.edi
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-edi:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-edi:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-edi:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-edi:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-edi.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest edi
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-edi
          subject-digest: ${{ steps.build-edi.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for financial-reports
        id: meta-financial-reports
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-financial-reports
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push financial-reports
        id: build-financial-reports
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.financial-reports
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-financial-reports:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-financial-reports:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-financial-reports:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-financial-reports:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-financial-reports.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest financial-reports
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-financial-reports
          subject-digest: ${{ steps.build-financial-reports.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for bff
        id: meta-bff
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-bff
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push bff
        id: build-bff
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.bff
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-bff:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-bff:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-bff:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-bff:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-bff.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest bff
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-bff
          subject-digest: ${{ steps.build-bff.outputs.digest }}
          push-to-registry: true

      - name: Extract metadata for website
        id: meta-website
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-website
          tags: type=raw,value=${{ steps.tag.outputs.tag }}

      - name: Build and push website
        id: build-website
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/website/Dockerfile
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-website:{1}', github.repository_owner, steps.tag.outputs.tag) }}${{ steps.tag.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-website:{1}', github.repository_owner, steps.tag.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-website:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && steps.tag.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-website:{1}', vars.DOCKERHUB_ORG, steps.tag.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta-website.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Attest website
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-website
          subject-digest: ${{ steps.build-website.outputs.digest }}
          push-to-registry: true

      - name: Verify published images
        run: |
          set -e
          TAG="${{ steps.tag.outputs.tag }}"
          OWNER="${{ github.repository_owner }}"
          for name in general-ledger invoice accounts-receivable accounts-payable bank-sync asset budget edi financial-reports bff; do
            img="ghcr.io/${OWNER}/rerp-${name}:${TAG}"
            echo "ğŸ” Inspecting $img ..."
            out=$(docker buildx imagetools inspect "$img" 2>&1) || { echo "âŒ $name: imagetools inspect failed"; exit 1; }
            echo "$out" | grep -qE 'Platform:.*linux/amd64'   || { echo "âŒ $name: missing linux/amd64";   exit 1; }
            echo "$out" | grep -qE 'Platform:.*linux/arm64'  || { echo "âŒ $name: missing linux/arm64";  exit 1; }
            echo "$out" | grep -qE 'Platform:.*linux/arm/v7' || { echo "âŒ $name: missing linux/arm/v7"; exit 1; }
            echo "âœ… $name: linux/amd64, linux/arm64, linux/arm/v7"
          done
          img="ghcr.io/${OWNER}/rerp-website:${TAG}"
          echo "ğŸ” Inspecting $img ..."
          out=$(docker buildx imagetools inspect "$img" 2>&1) || { echo "âŒ website: imagetools inspect failed"; exit 1; }
          echo "$out" | grep -qE 'Platform:.*linux/amd64' || { echo "âŒ website: missing linux/amd64"; exit 1; }
          echo "âœ… website: linux/amd64"
          echo "ğŸ‰ All 11 images verified (10 microservices: amd64, arm64, arm/v7; website: amd64)."
