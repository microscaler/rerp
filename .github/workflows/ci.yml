name: RERP CI

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_release_jobs:
        description: "Run container build and push jobs (release build). Set when dispatching to (re-)run release, or when invoked by release.yaml."
        required: false
        default: false
        type: boolean

concurrency:
  # Each ref gets its own group (tags, branches, PRs are isolated)
  group: ${{ github.workflow }}-${{ github.ref }}
  # CRITICAL: Only cancel PRs, NEVER cancel pushes (branches) or tags (releases)
  # Tags are never PRs, so they're automatically protected
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  pull-requests: read

env:
  RUST_BACKTRACE: "1"
  RUST_LOG: "info"
  PYTHON_VERSION: '3.12'

jobs:
  vars:
    name: Set CI vars
    runs-on: ubuntu-latest
    outputs:
      run_release_jobs: ${{ steps.set_vars.outputs.is_release_tag == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_release_jobs == 'true') }}
    steps:
      - uses: actions/checkout@v4
      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - run: pip install -e ./BRRTRouter/tooling && pip install -e ./tooling
      - id: set_vars
        run: echo "is_release_tag=$(rerp ci is-tag)" >> $GITHUB_OUTPUT
      - name: Validate version (prevent downgrade)
        if: steps.set_vars.outputs.is_release_tag == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_release_jobs == 'true')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # When running on a tag, extract version from the tag ref
          # Otherwise, read from microservices/Cargo.toml
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Extract version from tag (e.g., refs/tags/v0.1.3 -> 0.1.3)
            CURRENT=$(echo "${{ github.ref }}" | sed -E 's|refs/tags/v?||')
            echo "Running on tag: ${{ github.ref }}, version: $CURRENT"
          else
            # Read current version from microservices/Cargo.toml
            CURRENT=$(grep -A 5 '\[workspace.package\]' microservices/Cargo.toml | grep -E '^\s*version\s*=' | head -1 | sed -E 's/.*version\s*=\s*"v?([^"]+)".*/\1/' || echo "")
            if [ -z "$CURRENT" ]; then
              echo "Warning: Could not read version from microservices/Cargo.toml, skipping validation"
              exit 0
            fi
          fi
          
          # Get all tags and find the previous one (excluding current tag if we're on a tag)
          # Use git to get tags sorted by version, excluding the current tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            CURRENT_TAG=$(echo "${{ github.ref }}" | sed -E 's|refs/tags/||')
            # Get all tags, sort by version, exclude current tag, get the latest
            LATEST=$(git tag -l 'v*' | grep -v "^${CURRENT_TAG}$" | sort -V | tail -1 | sed 's/^v//' || echo "")
          else
            # Not on a tag, get latest from GitHub API
            if LATEST=$(rerp ci get-latest-tag); then
              LATEST="$LATEST"
            else
              echo "Error: Failed to get latest tag from GitHub API after retries. Cannot validate version safely."
              echo "This prevents accidental version downgrades. Please retry the workflow."
              exit 1
            fi
          fi
          
          if [ -n "$LATEST" ]; then
            echo "Validating version: current=$CURRENT, latest=$LATEST"
            rerp ci validate-version --current "$CURRENT" --latest "$LATEST" || exit 1
            echo "Version validation passed"
          else
            echo "No previous releases found, allowing first release"
          fi

  conventional-commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Lint commit messages
        uses: wagoid/commitlint-github-action@v5

  tooling:
    name: Build, Test and Coverage (Tooling)
    needs: [conventional-commits]
    # On tag push: conventional-commits is skipped; run so container pipeline (download/build-push/verify) can run.
    if: startsWith(github.ref, 'refs/tags/') || needs.conventional-commits.result == 'success' || needs.conventional-commits.result == 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./BRRTRouter/tooling
          tooling/.venv/bin/pip install -e ./tooling[dev]

      - name: Run tooling tests with coverage
        run: cd tooling && .venv/bin/pytest tests/ -v --cov=rerp_tooling --cov-report=term-missing --cov-fail-under=65

  validate-openapi:
    name: Validate OpenAPI Specs
    needs: [tooling]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./BRRTRouter/tooling
          tooling/.venv/bin/pip install -e ./tooling

      - name: Validate OpenAPI specs
        run: |
          echo "ğŸ” Validating OpenAPI specifications..."
          tooling/.venv/bin/rerp openapi validate

      - name: Generate BFF specs (dry run)
        run: |
          echo "ğŸ”„ Testing BFF spec generation..."
          tooling/.venv/bin/rerp bff generate-system
          echo "âœ… BFF spec generation successful"

  validate-ports:
    name: Validate Port Assignments
    needs: [validate-openapi]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./BRRTRouter/tooling
          tooling/.venv/bin/pip install -e ./tooling

      - name: Validate port assignments
        run: |
          echo "ğŸ” Validating port registry, helm, kind-config, Tiltfile..."
          tooling/.venv/bin/rerp ports validate

  build-and-test:
    name: Build and Test
    needs: [validate-ports]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./BRRTRouter/tooling
          tooling/.venv/bin/pip install -e ./tooling

      - name: Patch Cargo.toml to use BRRTRouter and lifeguard from git (CI)
        working-directory: ${{ github.workspace }}
        run: tooling/.venv/bin/rerp ci patch-brrtrouter

      - name: Cache cargo registry and git
        uses: actions/cache@v5
        id: cache-cargo-registry
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('microservices/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo target directory
        uses: actions/cache@v5
        id: cache-cargo-target
        with:
          path: microservices/target
          key: ${{ runner.os }}-cargo-target-amd64-${{ hashFiles('microservices/**/Cargo.toml', 'microservices/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-amd64-
      
      - name: Install musl target and tools
        run: |
          rustup target add x86_64-unknown-linux-musl
          sudo apt-get update
          sudo apt-get install -y musl-tools
      
      - name: Build workspace (amd64)
        run: |
          echo "ğŸ”¨ Building RERP workspace for amd64..."
          tooling/.venv/bin/rerp build workspace amd64
      
      - name: Build example service (amd64)
        run: |
          echo "ğŸ”¨ Building example service (accounting/general-ledger) for amd64..."
          tooling/.venv/bin/rerp build microservice general-ledger
      
      - name: Build accounting microservices (amd64) - smoke test
        run: |
          echo "ğŸ”¨ Building accounting microservices (workspace) for amd64..."
          tooling/.venv/bin/rerp build microservices amd64 --release
      
      - name: Format check
        run: |
          cd microservices
          cargo fmt --check || (echo "âŒ Code formatting check failed. Run 'cargo fmt' to fix." && exit 1)
      
      - name: Lint with Clippy
        run: |
          cd microservices
          cargo clippy --workspace -- -D warnings
      
      - name: Run tests
        run: |
          cd microservices
          cargo test --workspace --lib
      
      - name: Check documentation
        run: |
          cd microservices
          cargo doc --workspace --no-deps || true

  build-multiarch:
    name: Build Multi-Architecture
    needs: [build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    env:
      RERP_USE_CROSS: '1'   # Use cross-rs Docker images (include aarch64-linux-musl-gcc, etc.) so aws-lc-sys builds
    strategy:
      matrix:
        architecture: [amd64, arm64, arm7]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./BRRTRouter/tooling
          tooling/.venv/bin/pip install -e ./tooling

      - name: Patch Cargo.toml to use BRRTRouter and lifeguard from git (CI)
        working-directory: ${{ github.workspace }}
        run: tooling/.venv/bin/rerp ci patch-brrtrouter

      - name: Cache cargo registry and git
        uses: actions/cache@v5
        id: cache-cargo-registry
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('microservices/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo target (per-architecture)
        uses: actions/cache@v5
        id: cache-cargo-target
        with:
          path: microservices/target
          key: ${{ runner.os }}-cargo-target-${{ matrix.architecture }}-${{ hashFiles('microservices/**/Cargo.toml', 'microservices/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ matrix.architecture }}-

      - name: Install cross
        run: cargo install cross

      - name: Build workspace for ${{ matrix.architecture }}
        run: |
          echo "ğŸ”¨ Building RERP workspace for ${{ matrix.architecture }}..."
          tooling/.venv/bin/rerp build workspace ${{ matrix.architecture }}

      - name: Build microservices for ${{ matrix.architecture }}
        run: |
          echo "ğŸ”¨ Building microservices for ${{ matrix.architecture }}..."
          tooling/.venv/bin/rerp build microservices ${{ matrix.architecture }} --release

      - name: Copy microservices to build_artifacts
        run: tooling/.venv/bin/rerp docker copy-artifacts ${{ matrix.architecture }}

      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: rerp-binaries-${{ matrix.architecture }}
          path: microservices/target/*/release/rerp_*
          retention-days: 1
          if-no-files-found: warn

      - name: Upload microservices binaries
        uses: actions/upload-artifact@v6
        with:
          name: microservices-binaries-${{ matrix.architecture == 'arm7' && 'arm' || matrix.architecture }}
          path: build_artifacts/${{ matrix.architecture == 'arm7' && 'arm' || matrix.architecture }}
          retention-days: 1
          if-no-files-found: error

  # Runs only on tag push (release). Extracts tag from github.ref (e.g. v0.1.1 â†’ 0.1.1) and passes
  # it via outputs.tag; extra_tag=latest so images are pushed with both :0.1.1 and :latest.
  download-copy-package-push-containers:
    name: Download Copy Package and Push Containers
    needs: [build-multiarch, vars]
    if: needs.vars.outputs.run_release_jobs == 'true' && needs.build-multiarch.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      extra_tag: ${{ steps.tag.outputs.extra_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Checkout BRRTRouter (brrtrouter-tooling dependency)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/BRRTRouter
          path: BRRTRouter
          ref: main

      - name: Set up Python and tooling (for validate)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./BRRTRouter/tooling
          tooling/.venv/bin/pip install -e ./tooling

      - name: Copy microservices binaries (amd64) from build-multiarch artifacts
        uses: actions/download-artifact@v4
        with:
          name: microservices-binaries-amd64
          path: build_artifacts/amd64

      - name: Copy microservices binaries (arm64) from build-multiarch artifacts
        uses: actions/download-artifact@v4
        with:
          name: microservices-binaries-arm64
          path: build_artifacts/arm64

      - name: Copy microservices binaries (arm) from build-multiarch artifacts
        uses: actions/download-artifact@v4
        with:
          name: microservices-binaries-arm
          path: build_artifacts/arm

      - name: Validate build_artifacts
        run: tooling/.venv/bin/rerp docker validate-build-artifacts

      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
            echo "extra_tag=latest" >> "$GITHUB_OUTPUT"
          else
            # CRITICAL: Never set latest tag for non-tag builds (even workflow_dispatch from main)
            # Only official release tags (created by release.yml) should set latest tag
            echo "tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
            echo "extra_tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload build_artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: build_artifacts
          retention-days: 1

  # Image tag comes from download-copy-package-push-containers.outputs.tag (release version from
  # github.ref on tag push, e.g. 0.1.1), so images are associated with the GitHub Release.
  build-push-service:
    name: Build and push ${{ matrix.service }}
    needs: [download-copy-package-push-containers, vars]
    if: needs.vars.outputs.run_release_jobs == 'true' && needs.download-copy-package-push-containers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write  # required for actions/attest-build-provenance (create attestation API)
    strategy:
      fail-fast: false
      matrix:
        service: [general-ledger, invoice, accounts-receivable, accounts-payable, bank-sync, asset, budget, edi, financial-reports, bff]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Copy microservices binaries from artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build_artifacts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        if: ${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.service }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/rerp-accounting-${{ matrix.service }}
          tags: type=raw,value=${{ needs.download-copy-package-push-containers.outputs.tag }}

      - name: Build and push ${{ matrix.service }}
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/microservices/Dockerfile.${{ matrix.service }}
          push: true
          tags: ${{ format('ghcr.io/{0}/rerp-accounting-{1}:{2}', github.repository_owner, matrix.service, needs.download-copy-package-push-containers.outputs.tag) }}${{ needs.download-copy-package-push-containers.outputs.extra_tag != '' && format(',ghcr.io/{0}/rerp-accounting-{1}:{2}', github.repository_owner, matrix.service, needs.download-copy-package-push-containers.outputs.extra_tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && format(',docker.io/{0}/rerp-accounting-{1}:{2}', vars.DOCKERHUB_ORG, matrix.service, needs.download-copy-package-push-containers.outputs.tag) || '' }}${{ vars.DOCKERHUB_ORG != '' && vars.DOCKERHUB_ORG != 'null' && needs.download-copy-package-push-containers.outputs.extra_tag != '' && format(',docker.io/{0}/rerp-accounting-{1}:{2}', vars.DOCKERHUB_ORG, matrix.service, needs.download-copy-package-push-containers.outputs.extra_tag) || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Attest ${{ matrix.service }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/rerp-accounting-${{ matrix.service }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  # Uses the same release tag (download-copy-package-push-containers.outputs.tag) to verify images.
  verify-published-images:
    name: Verify published images
    needs: [download-copy-package-push-containers, build-push-service, vars]
    if: needs.vars.outputs.run_release_jobs == 'true' && needs.download-copy-package-push-containers.result == 'success' && needs.build-push-service.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read  # for docker buildx imagetools inspect of ghcr.io images

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify published images
        run: |
          set -e
          TAG="${{ needs.download-copy-package-push-containers.outputs.tag }}"
          OWNER="${{ github.repository_owner }}"
          echo "â³ Waiting 10s for registry propagation after parallel pushes..."
          sleep 10
          for name in general-ledger invoice accounts-receivable accounts-payable bank-sync asset budget edi financial-reports bff; do
            img="ghcr.io/${OWNER}/rerp-accounting-${name}:${TAG}"
            echo "ğŸ” Inspecting $img ..."
            out=$(docker buildx imagetools inspect "$img" 2>&1) || { echo "âŒ $name: imagetools inspect failed:"; echo "$out"; exit 1; }
            echo "$out" | grep -qE 'Platform:.*linux/amd64'   || { echo "âŒ $name: missing linux/amd64";   exit 1; }
            echo "$out" | grep -qE 'Platform:.*linux/arm64'  || { echo "âŒ $name: missing linux/arm64";  exit 1; }
            echo "$out" | grep -qE 'Platform:.*linux/arm/v7' || { echo "âŒ $name: missing linux/arm/v7"; exit 1; }
            echo "âœ… $name: linux/amd64, linux/arm64, linux/arm/v7"
          done
          echo "ğŸ‰ All 10 microservice images verified (linux/amd64, linux/arm64, linux/arm/v7)."

