# Clippy Decimal/Money Type Fixes Required

## Summary
Clippy found 50+ errors where `3.14` (f64) is used instead of `rust_decimal::Decimal` in gen controllers. This triggers `approx_constant` warnings because `3.14` is an approximation of the mathematical constant π (PI).

**Key Finding**: BRRTRouter **already supports** Decimal types, but handlers for some services need to be **regenerated** to pick up this support.

## Root Cause Analysis

### 1. OpenAPI Spec Format
The OpenAPI specs correctly use:
- `format: money` for monetary amounts (e.g., `purchase_cost`, `outstanding_amount`)
- `format: decimal` for decimal values (e.g., `tax_rate`, `depreciation_rate`, `variance_percent`)

### 2. Handler Types (Auto-Generated)
**Problem**: Handlers are auto-generated by BRRTRouter but still use `f64` instead of `rust_decimal::Decimal`:
- ✅ **accounts-payable**: Handlers use `Option<rust_decimal::Decimal>` (already fixed)
- ❌ **invoice**: Handlers use `Option<f64>` for `tax_rate`
- ❌ **asset**: Handlers use `Option<f64>` for `accumulated_depreciation`, `depreciation_rate`, `salvage_value`
- ❌ **budget**: Handlers use `Option<f64>` for `actual_amount`, `variance`, `variance_percent`
- ❌ **accounts-receivable**: Handlers use `Option<f64>` for `credit_limit`, `credit_used`, etc.

### 3. Controller Implementations
**Gen Controllers** (stub implementations in `gen/src/controllers/`):
- Use `3.14` (f64) to match handler types
- Need to use `rust_decimal::Decimal::new(value, scale)` once handlers are fixed

**Impl Controllers** (user-owned in `impl/src/controllers/`):
- Also use `3.14` (f64) 
- Need to be updated to use `Decimal::new()` for consistency

## How Lifeguard Handles This

From `../lifeguard`:
1. **Entities use `rust_decimal::Decimal`** directly:
   ```rust
   #[column_type = "NUMERIC(19, 4)"]
   pub debit_amount: rust_decimal::Decimal,
   ```

2. **Lifeguard-derive supports Decimal**:
   - `is_decimal_type()` checks for `rust_decimal::Decimal`
   - `is_money_type()` checks for `rusty_money::Money<Currency>`
   - Type conversion handles Decimal properly

3. **Workspace dependencies**:
   ```toml
   rust_decimal = "1.33"
   rusty-money = { version = "0.5", features = ["serde"] }
   ```

## Services Requiring Fixes

### Invoice Service
**Fields**: `tax_rate` (format: decimal)
- **Handlers**: `create_invoice_line.rs`, `get_invoice_line.rs`, `update_invoice_line.rs`
- **Gen Controllers**: All use `Some(3.14)` - need `Decimal::new(314, 2)` for 3.14%
- **Impl Controllers**: `create_invoice_line.rs`, `get_invoice_line.rs`, `update_invoice_line.rs`

### Asset Service  
**Fields**: 
- `accumulated_depreciation` (format: decimal)
- `depreciation_rate` (format: decimal)
- `salvage_value` (format: money)

**Files**:
- **Handlers**: `create_asset.rs`, `get_asset.rs`, `update_asset.rs`
- **Gen Controllers**: All use `Some(3.14)` 
- **Impl Controllers**: Need to check if they exist

### Budget Service
**Fields**:
- `actual_amount` (format: money/decimal)
- `variance` (format: decimal)
- `variance_percent` (format: decimal)
- `total_actual_amount` (format: money)
- `total_variance` (format: decimal)

**Files**:
- **Handlers**: `create_budget_line.rs`, `get_budget_line.rs`, `update_budget_line.rs`, `create_budget_variance.rs`, `get_budget_variance.rs`, `update_budget_variance.rs`, `create_budget.rs`, `get_budget.rs`, `update_budget.rs`
- **Gen Controllers**: All use `Some(3.14)`
- **Impl Controllers**: Need to check

### Accounts Receivable Service
**Fields**:
- `credit_limit` (format: money)
- `credit_used` (format: money)
- `last_payment_amount` (format: money)
- `write_off_amount` (format: money)

**Files**:
- **Handlers**: `create_customer_invoice.rs`, `get_customer_invoice.rs`, `update_customer_invoice.rs`
- **Gen Controllers**: All use `Some(3.14)`
- **Impl Controllers**: Need to check

## BRRTRouter Implementation Status

### ✅ Already Implemented
BRRTRouter **already has support** for `rust_decimal::Decimal` and `rusty-money::Money`:

1. **Type Mapping** (`src/generator/schema.rs` lines 688-696, 772-782, 793-798):
   ```rust
   match prop.get("format").and_then(|f| f.as_str()) {
       // For API serialization, use Decimal for money (Money has lifetime parameter incompatible with owned Deserialize)
       // Money types should be used in entities, converted from Decimal in business logic
       Some("money") => "rust_decimal::Decimal".to_string(),
       Some("decimal") => "rust_decimal::Decimal".to_string(),
       _ => "f64".to_string(), // Default to f64 for mathematical numbers
   }
   ```
   - ✅ `format: money` → `rust_decimal::Decimal`
   - ✅ `format: decimal` → `rust_decimal::Decimal`
   - ✅ No format → `f64` (for mathematical numbers)

2. **Dummy Value Generation** (`src/dummy_value.rs`):
   ```rust
   "rust_decimal::Decimal" => {
       // General decimal: 123.45
       "rust_decimal::Decimal::new(12345, 2)".to_string()
   }
   "rusty_money::Money" | "rusty_money::Money<rusty_money::iso::Currency>" => {
       // Money: $3.14 USD - clearly a dollar amount, not PI
       // from_minor(314, USD) = 314 cents = $3.14
       "rusty_money::Money::from_minor(314, rusty_money::iso::USD)".to_string()
   }
   ```
   - ✅ Generates `Decimal::new(12345, 2)` for Decimal types (123.45)
   - ✅ Generates `Money::from_minor(314, USD)` for Money types ($3.14)
   - ⚠️ Still generates `3.14` for `f64` types (causes clippy warnings)

3. **Example Value Conversion** (`src/generator/schema.rs` lines 273-298, 344-360):
   - ✅ Converts JSON number values to `Decimal::new(mantissa, scale)` when field type is Decimal
   - ✅ Handles both scalar and array values
   - ✅ Preserves precision by parsing as string first

4. **Design Decision**:
   - **API Layer**: Uses `rust_decimal::Decimal` for both `format: money` and `format: decimal`
   - **Entity Layer**: Should use `rusty_money::Money<Currency>` for money values
   - **Rationale**: `Money` has lifetime parameters incompatible with owned `Deserialize`, so API uses `Decimal` and converts to `Money` in business logic

### ⚠️ Current Issue
**Handlers were generated before BRRTRouter had Decimal support, or need regeneration:**
- Some services (invoice, asset, budget, accounts-receivable) still have handlers using `f64`
- **OpenAPI specs are already correct** - all number fields have `format: decimal` or `format: money`
- These handlers need to be **regenerated** from OpenAPI specs to pick up Decimal types
- Once regenerated, they will automatically use `Decimal` for `format: decimal`/`format: money` fields

## Solution Steps

### Step 1: Regenerate Handlers from OpenAPI Specs
**Action Required**: Regenerate handlers using BRRTRouter to pick up Decimal type support.

**Command** (example):
```bash
# Regenerate handlers for affected services
tooling/.venv/bin/rerp openapi generate <service-name>
# Or regenerate all accounting services
```

**Expected Result**:
- Handlers will automatically use `rust_decimal::Decimal` for fields with `format: decimal` or `format: money`
- Gen controllers will be regenerated with `Decimal::new()` dummy values instead of `3.14`

### Step 2: Verify Gen Controllers (Auto-Generated)
**After regeneration**, gen controllers should automatically use `Decimal::new()`:
- BRRTRouter's `dummy_value()` function generates `Decimal::new(12345, 2)` for Decimal types
- Example value conversion also handles Decimal properly
- **No manual changes needed** if regeneration works correctly

**If gen controllers still use `3.14` after regeneration**:
- Check that OpenAPI spec has `format: decimal` or `format: money` for the field
- Verify BRRTRouter version includes Decimal support
- May need to manually update if there's a bug in codegen

### Step 3: Update Impl Controllers (User-Owned)
**Manual update required** for user-owned impl controllers:
```rust
// Before
tax_rate: Some(3.14),

// After
tax_rate: Some(rust_decimal::Decimal::new(314, 2)), // 3.14% = 314/100
```

**Conversion Guide**:
- `3.14` → `Decimal::new(314, 2)` (2 decimal places)
- `0.0` → `Decimal::new(0, 1)` (zero with 1 decimal place)
- `7500.0` → `Decimal::new(75000, 1)` (7500.0 = 75000/10)
- `15000.0` → `Decimal::new(150000, 1)` (15000.0 = 150000/10)
- `123.45` → `Decimal::new(12345, 2)` (123.45 = 12345/100)

### Step 4: Ensure Dependencies
**Automatic**: The bootstrap tool (`tooling/src/rerp_tooling/bootstrap/microservice.py`) automatically:
- Detects `rust_decimal::Decimal` usage in generated code
- Detects `rusty_money::Money` usage in generated code
- Adds `rust_decimal = { workspace = true }` to `gen/Cargo.toml` if Decimal is used
- Adds `rusty-money = { workspace = true }` to `gen/Cargo.toml` if Money is used

**Manual Check**: Verify that affected `gen/Cargo.toml` and `impl/Cargo.toml` files have:
```toml
rust_decimal = { workspace = true }
```

**Workspace Level**: Already configured in `microservices/Cargo.toml`:
```toml
rust_decimal = "1.33"
rusty-money = { version = "0.5", features = ["serde"] }
```

## OpenAPI Spec Status

✅ **All OpenAPI specs have correct formats**:
- ✅ **invoice**: `tax_rate` has `format: decimal`
- ✅ **asset**: `accumulated_depreciation` (format: decimal), `depreciation_rate` (format: decimal), `salvage_value` (format: money)
- ✅ **budget**: `actual_amount` (format: money), `variance` (format: money), `variance_percent` (format: decimal), `total_actual_amount` (format: money), `total_variance` (format: money)
- ✅ **accounts-receivable**: `credit_limit`, `credit_used`, `last_payment_amount`, `write_off_amount` all have `format: money`
- ✅ **accounts-payable**: All decimal/money fields have correct formats
- ✅ **bank-sync**: All balance fields have `format: money`
- ✅ **general-ledger**: All amount fields have `format: money`

**Verification**: All number fields that represent money or decimals have `format: decimal` or `format: money` specified.

## Current Status

✅ **OpenAPI Specs**: All have correct `format: decimal` or `format: money` for number fields

✅ **accounts-payable**: 
- Handlers use `Decimal` ✓
- Gen controllers use `Decimal::new()` ✓
- Impl controllers use `Decimal::new()` ✓

❌ **invoice**: Handlers still use `f64` (need regeneration)
❌ **asset**: Handlers still use `f64` (need regeneration)
❌ **budget**: Handlers still use `f64` (need regeneration)
❌ **accounts-receivable**: Handlers still use `f64` (need regeneration)

## Next Actions

1. **Immediate**: **Regenerate handlers** from OpenAPI specs using BRRTRouter
   - BRRTRouter already supports Decimal types
   - Regeneration will update handlers to use `Decimal` for `format: decimal`/`format: money`
   - Gen controllers will be auto-updated with `Decimal::new()` values

2. **After regeneration**: **Verify gen controllers** use `Decimal::new()` instead of `3.14`
   - Should be automatic, but verify
   - Check that dummy values are correct (e.g., `Decimal::new(12345, 2)` for 123.45)

3. **After regeneration**: **Update impl controllers** to use `Decimal::new()` instead of `3.14`
   - Manual update required (user-owned code)
   - Follow conversion guide above

4. **Verify**: Run `cargo clippy --workspace -- -D warnings` to confirm all errors resolved

## Technical Details

### BRRTRouter Code Locations
- **Type Mapping**: `src/generator/schema.rs` lines 688-696, 772-782, 793-798
- **Dummy Values**: `src/dummy_value.rs` lines 8-16
- **Example Conversion**: `src/generator/schema.rs` lines 273-298, 344-360

### Why Some Handlers Still Use f64
- Handlers were generated **before** BRRTRouter Decimal support was added
- OR handlers need to be regenerated to pick up the new type mapping
- **Solution**: Regenerate handlers from OpenAPI specs

### Why Decimal Instead of Money in API Layer
From BRRTRouter comments:
> "For API serialization, use Decimal for money (Money has lifetime parameter incompatible with owned Deserialize). Money types should be used in entities, converted from Decimal in business logic."

This is a design decision:
- **API Layer** (handlers): Use `rust_decimal::Decimal` for serialization compatibility
- **Entity Layer**: Use `rusty_money::Money<Currency>` for type safety and currency handling
- **Business Logic**: Convert between `Decimal` (from API) and `Money` (for entities) as needed

### How to Check if Handlers Need Regeneration
To verify if a service's handlers need regeneration, check the handler files:

```bash
# Check if handler uses f64 for decimal/money fields
grep -r "Option<f64>" microservices/accounting/invoice/gen/src/handlers/ | grep -E "(tax_rate|amount|rate)"

# Check if handler uses Decimal (correct)
grep -r "rust_decimal::Decimal" microservices/accounting/accounts-payable/gen/src/handlers/ | head -5
```

**Services needing regeneration** (handlers use `f64`):
- ❌ invoice: `tax_rate` uses `Option<f64>`
- ❌ asset: `accumulated_depreciation`, `depreciation_rate`, `salvage_value` use `Option<f64>`
- ❌ budget: `actual_amount`, `variance`, `variance_percent` use `Option<f64>`
- ❌ accounts-receivable: `credit_limit`, `credit_used`, etc. use `Option<f64>`

**Services already correct** (handlers use `Decimal`):
- ✅ accounts-payable: All decimal/money fields use `Option<rust_decimal::Decimal>`
