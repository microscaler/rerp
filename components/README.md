# RERP Components

This directory contains all RERP microservice crates organized as a Rust workspace, following the same pattern as PriceWhisperer.

## Structure

Each RERP service consists of two crates:

1. **Generated Crate** (`{system}/{module}/`): Auto-generated from OpenAPI specification
   - Contains handlers, types, and registry generated by BRRTRouter
   - Located at: `components/{system}/{module}/`
   - OpenAPI spec: `../openapi/{system}/{module}/openapi.yaml`

2. **Implementation Crate** (`{system}/{module}_impl/`): Business logic implementation
   - Contains controllers with business logic
   - Located at: `components/{system}/{module}_impl/`
   - Depends on the generated crate

## Workspace Organization

The workspace is defined in `components/Cargo.toml` with:
- **Workspace Members**: All 142 crates (71 services × 2 crates each)
- **Workspace Dependencies**: Shared dependencies like `brrtrouter`, `serde`, etc.
- **Common Crate**: Shared utilities in `components/common/`

## Crate Naming Convention

- Generated crates: `rerp_{system}_{module}` (e.g., `rerp_auth_idam`)
- Implementation crates: `rerp_{system}_{module}_impl` (e.g., `rerp_auth_idam_impl`)
- Common crate: `rerp_common`

## Service Directory Structure

```
components/
├── Cargo.toml                    # Workspace configuration
├── common/                        # Shared utilities
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs
│       ├── error.rs
│       ├── validation.rs
│       └── utils.rs
├── {system}/
│   ├── {module}/                 # Generated crate
│   │   ├── Cargo.toml
│   │   ├── doc/
│   │   │   └── openapi.yaml      # Link to ../openapi/{system}/{module}/openapi.yaml
│   │   └── src/                  # Generated code (auto-generated)
│   │       ├── main.rs           # Generated server entry point
│   │       ├── handlers/          # Generated handlers
│   │       ├── types.rs          # Generated types
│   │       └── registry.rs       # Generated registry
│   └── {module}_impl/            # Implementation crate
│       ├── Cargo.toml
│       ├── config/
│       │   └── config.yaml       # Service configuration
│       └── src/
│           ├── main.rs           # Implementation entry point
│           └── controllers/     # Business logic controllers
│               └── mod.rs
```

## Example: Auth IDAM Service

```
components/
├── auth/
│   ├── idam/                     # Generated crate
│   │   ├── Cargo.toml
│   │   ├── doc/
│   │   │   └── openapi.yaml      # Links to ../../openapi/auth/idam/openapi.yaml
│   │   └── src/                  # Auto-generated by BRRTRouter
│   └── idam_impl/                # Implementation crate
│       ├── Cargo.toml
│       ├── config/
│       │   └── config.yaml
│       └── src/
│           ├── main.rs
│           └── controllers/
│               ├── mod.rs
│               ├── login.rs
│               └── register.rs
```

## Generating Code from OpenAPI

To generate code for a service:

```bash
cd components/{system}/{module}
brrtrouter-gen --spec ../../openapi/{system}/{module}/openapi.yaml
```

This will:
1. Generate handlers, types, and registry in the generated crate
2. Create implementation crate structure if it doesn't exist

## Building Services

Build all services:
```bash
cd components
cargo build
```

Build a specific service:
```bash
cd components
cargo build -p rerp_auth_idam_impl
```

## Running Services

Run an implementation service:
```bash
cd components/{system}/{module}_impl
cargo run --bin {module} -- --spec ../../openapi/{system}/{module}/openapi.yaml
```

## Dependencies

All services share workspace dependencies defined in `components/Cargo.toml`:
- `brrtrouter`: BRRTRouter framework (path dependency to `../BRRTRouter`)
- `brrtrouter_macros`: BRRTRouter macros
- `serde`, `serde_json`, `serde_yaml`: Serialization
- `config`: Configuration management
- `may`, `may_minihttp`: Coroutine-based HTTP server
- `clap`: CLI argument parsing
- `tikv-jemallocator`: Memory allocator

## Common Crate

The `common` crate provides shared utilities:
- Error types (`RerpError`, `RerpResult`)
- Validation utilities (email, phone)
- Utility functions (timestamps, currency formatting)

All implementation crates depend on `rerp_common` for shared functionality.

## Next Steps

1. Generate code for each service from OpenAPI specs
2. Implement business logic in controller files
3. Add service-specific dependencies as needed
4. Test services individually and as a workspace

---

**Status**: Workspace structure created - Ready for code generation
